defmodule YIFY.SubtitlesTest do
  use ExUnit.Case, async: false

  import Mock

  test "find a subtitle when imdb id exists" do
    with_mock HTTPoison, [get!: fn("http://api.yifysubtitles.com/subs/tt0133093") -> ~s({ "success": true, "lastModified": 1430854107, "subtitles": 27, "subs": { "tt0133093": { "english": [ { "id": 742, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-742.zip" }, { "id": 39316, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-39316.zip" }, { "id": 40402, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-40402.zip" } ], "brazilian-portuguese": [ { "id": 9841, "hi": 0, "rating": 4, "url": "/subtitle-api/the-matrix-yify-9841.zip" } ], "dutch": [ { "id": 7566, "hi": 0, "rating": 2, "url": "/subtitle-api/the-matrix-yify-7566.zip" } ], "farsi-persian": [ { "id": 743, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-743.zip" } ], "greek": [ { "id": 9816, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-9816.zip" } ], "indonesian": [ { "id": 32218, "hi": 0, "rating": 1, "url": "/subtitle-api/the-matrix-yify-32218.zip" } ], "korean": [ { "id": 10418, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-10418.zip" }, { "id": 13211, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-13211.zip" } ], "portuguese": [ { "id": 11078, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-11078.zip" } ], "spanish": [ { "id": 4242, "hi": 0, "rating": 4, "url": "/subtitle-api/the-matrix-yify-4242.zip" } ], "french": [ { "id": 24107, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-24107.zip" } ], "serbian": [ { "id": 10883, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-10883.zip" } ], "arabic": [ { "id": 741, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-741.zip" } ], "romanian": [ { "id": 17462, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-17462.zip" } ], "hebrew": [ { "id": 10996, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-10996.zip" } ], "italian": [ { "id": 12961, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-12961.zip" } ], "russian": [ { "id": 41611, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-41611.zip" }, { "id": 41647, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-41647.zip" } ], "chinese": [ { "id": 18505, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-18505.zip" }, { "id": 17090, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-17090.zip" } ], "slovenian": [ { "id": 15236, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-15236.zip" } ], "hungarian": [ { "id": 42520, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-42520.zip" } ], "bengali": [ { "id": 23870, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-23870.zip" }, { "id": 4241, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-4241.zip" } ], "bulgarian": [ { "id": 40238, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-40238.zip" } ] } } }) end] do
      assert Map.size(YIFY.Subtitles.find_by_imdb_id("tt0133093")) == 21
    end
  end

  test "find a subtitle with only specified languages when imdb id exists" do
    with_mock HTTPoison, [get!: fn("http://api.yifysubtitles.com/subs/tt0133093") -> ~s({ "success": true, "lastModified": 1430854107, "subtitles": 27, "subs": { "tt0133093": { "english": [ { "id": 742, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-742.zip" }, { "id": 39316, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-39316.zip" }, { "id": 40402, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-40402.zip" } ], "brazilian-portuguese": [ { "id": 9841, "hi": 0, "rating": 4, "url": "/subtitle-api/the-matrix-yify-9841.zip" } ], "dutch": [ { "id": 7566, "hi": 0, "rating": 2, "url": "/subtitle-api/the-matrix-yify-7566.zip" } ], "farsi-persian": [ { "id": 743, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-743.zip" } ], "greek": [ { "id": 9816, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-9816.zip" } ], "indonesian": [ { "id": 32218, "hi": 0, "rating": 1, "url": "/subtitle-api/the-matrix-yify-32218.zip" } ], "korean": [ { "id": 10418, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-10418.zip" }, { "id": 13211, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-13211.zip" } ], "portuguese": [ { "id": 11078, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-11078.zip" } ], "spanish": [ { "id": 4242, "hi": 0, "rating": 4, "url": "/subtitle-api/the-matrix-yify-4242.zip" } ], "french": [ { "id": 24107, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-24107.zip" } ], "serbian": [ { "id": 10883, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-10883.zip" } ], "arabic": [ { "id": 741, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-741.zip" } ], "romanian": [ { "id": 17462, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-17462.zip" } ], "hebrew": [ { "id": 10996, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-10996.zip" } ], "italian": [ { "id": 12961, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-12961.zip" } ], "russian": [ { "id": 41611, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-41611.zip" }, { "id": 41647, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-41647.zip" } ], "chinese": [ { "id": 18505, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-18505.zip" }, { "id": 17090, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-17090.zip" } ], "slovenian": [ { "id": 15236, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-15236.zip" } ], "hungarian": [ { "id": 42520, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-42520.zip" } ], "bengali": [ { "id": 23870, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-23870.zip" }, { "id": 4241, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-4241.zip" } ], "bulgarian": [ { "id": 40238, "hi": 0, "rating": 0, "url": "/subtitle-api/the-matrix-yify-40238.zip" } ] } } }) end] do
       %{ "english" => _, "french" => _ } = YIFY.Subtitles.find_by_imdb_id("tt0133093", ["french", "english"])
    end
  end

  test "find a subtitle when imdb id does not exist" do
    with_mock HTTPoison, [get!: fn("http://api.yifysubtitles.com/subs/tt0000000") -> ~s({ "success": true, "lastModified": 1430855520, "subtitles": 0 }) end] do
      assert YIFY.Subtitles.find_by_imdb_id("tt0000000") == %{}
    end
  end

  test "find a subtitle with only specified languages when imdb id does not exist" do
    with_mock HTTPoison, [get!: fn("http://api.yifysubtitles.com/subs/tt0000000") -> ~s({ "success": true, "lastModified": 1430855520, "subtitles": 0 }) end] do
       assert YIFY.Subtitles.find_by_imdb_id("tt0000000", ["french", "english"]) == %{}
    end
  end
end
